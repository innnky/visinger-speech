import numpy as np
import soundfile
import torch
from scipy.interpolate import interp1d

import utils
from models import SynthesizerTrn
from sing.remap_phone import singing_phone_to_sequence
from text import symbols
phseq = "SP w o y E x iang sh uo z ai ai j ian a SP f eng y ve m eng h ua SP b a x iang y v n ian l iu x ia SP SP k e k an d ao ch uang t ai SP w ei w ei y ao y E d e h ua SP q ve n an y i z i0 b a a SP"
phseq = phseq.split(" ")
phseq = singing_phone_to_sequence(phseq)
phseq = np.array(phseq)
durations = [25,  3, 12,  5, 10,  8, 10,  7, 11,  6, 11, 16,  7, 18, 34,  6, 11, 28,
          7, 26,  8, 10,  7, 35, 14,  3, 19, 16, 27,  7, 11,  6, 26,  9, 31, 20,
         35,  4,21,   7,  28,   7,  29,   5,  24,  10,  10,   8,  34,  11,   8,  11,
           5,  11,   6,  12,   5,  14,   3,   8,   9,  35,   7,  10,  11,   6,
          12,   6,  24,  10,  13,   4,  17, 104,   4]
durations = np.array(durations)
f0 = [348.4000, 348.4966, 348.8000, 348.7000, 348.5000, 348.4000, 348.3000,
         348.1746, 348.0424, 347.9000, 347.7780, 347.6458, 347.5136, 347.3814,
         347.2492, 347.1170, 346.9848, 346.8526, 346.7204, 260.1930, 251.2002,
         245.9476, 240.9406, 236.0476, 234.9279, 237.0399, 239.3835, 252.0510,
         284.9984, 312.9896, 335.2191, 345.3565, 348.6304, 348.8626, 349.3896,
         350.3810, 351.4551, 351.4086, 350.5349, 346.6286, 340.0567, 334.1193,
         337.1857, 348.5902, 365.7921, 382.8796, 392.3295, 397.0268, 396.9177,
         395.6889, 394.3803, 388.6551, 368.4286, 330.7410, 341.7408, 360.5358,
         370.6016, 378.1089, 388.7462, 400.2896, 409.7986, 418.2551, 421.7456,
         439.2857, 447.9900, 448.5000, 446.0218, 442.3837, 441.9791, 442.8088,
         443.0841, 435.5363, 405.8551, 379.5420, 407.8735, 430.3973, 439.8887,
         440.4381, 441.7578, 442.9626, 460.4445, 472.1000, 471.7789, 470.5646,
         468.6762, 467.2304, 466.3841, 467.5041, 465.7624, 455.7365, 427.7816,
         390.2079, 365.1079, 362.9075, 365.5352, 373.4635, 379.7878, 384.9605,
         388.7556, 393.4694, 393.3603, 392.4000, 392.6844, 391.7503, 391.3488,
         393.3333, 397.9288, 405.3501, 417.2102, 428.1510, 435.5907, 439.3673,
         439.9873, 439.3229, 439.2122, 439.8118, 441.0109, 442.3367, 443.7973,
         442.7095, 439.8129, 434.6195, 415.4719, 394.3313, 398.3025, 412.3957,
         428.9000, 443.1286, 457.9494, 473.5605, 490.4737, 512.2866, 532.1157,
         535.5698, 532.7705, 532.0123, 529.7295, 528.1887, 527.7565, 526.8456,
         524.4127, 521.2374, 517.2936, 516.6136, 517.7510, 520.5894, 521.7045,
         522.7000, 526.2106, 534.5206, 535.4803, 534.3272, 533.4227, 532.1938,
         530.3190, 526.0723, 522.0605, 518.1700, 515.3873, 516.4578, 518.2673,
         522.8873, 528.6755, 533.3853, 535.8265, 535.8578, 531.3365, 524.3256,
         517.9714, 513.2993, 512.1957, 514.8286, 520.0347, 526.7862, 534.2870,
         539.7587, 541.8315, 539.2109, 532.3392, 523.1238, 513.8674, 508.6655,
         512.6667, 515.5000, 515.6247, 515.4724, 512.9871, 508.5392, 498.3961,
         477.1429, 436.3560, 380.2703, 325.4320, 292.5197, 274.5512, 267.1272,
         263.8333, 262.6968, 262.3510, 262.8154, 263.1798, 263.2558, 262.6052,
         257.8794, 254.7816, 252.8000, 253.6304, 256.7143, 259.9626, 262.3782,
         263.7095, 263.5118, 262.4843, 260.1245, 259.6093, 259.2374, 260.3102,
         260.6746, 261.0390, 261.7551, 262.5517, 262.5000, 262.4483, 262.9415,
         262.0857, 259.5265, 255.8664, 251.3048, 245.1551, 239.5472, 236.1234,
         234.1238, 235.4138, 242.9995, 268.7429, 311.2773, 341.7066, 359.3326,
         362.7270, 361.1560, 357.8537, 355.3394, 355.8383, 359.5143, 366.1007,
         375.0778, 385.5272, 391.1256, 394.8839, 395.7708, 394.4512, 392.4254,
         391.1143, 390.3465, 390.5574, 391.0327, 392.2585, 393.9517, 394.5000,
         394.5603, 393.0093, 387.8143, 382.9018, 383.1163, 385.8143, 391.7535,
         397.4921, 404.5129, 414.7583, 435.4893, 444.9959, 445.9782, 446.0086,
         444.1857, 440.2599, 437.7744, 439.2224, 438.9422, 432.5925, 416.7980,
         385.8333, 372.5789, 372.5674, 378.7367, 387.3995, 397.6360, 415.5800,
         433.5286, 443.3571, 448.1454, 449.5515, 448.9490, 445.3478, 440.1107,
         435.1667, 431.3102, 429.5826, 430.0796, 431.8592, 436.6639, 442.2367,
         448.4698, 451.9456, 452.0354, 448.3154, 441.0490, 433.2204, 428.7211,
         426.4127, 427.6953, 431.0098, 435.2655, 441.2952, 446.8907, 449.9066,
         450.9714, 447.5991, 441.0243, 432.1823, 421.5755, 414.7653, 414.5081,
         415.5095, 416.0973, 415.2041, 412.8678, 406.3973, 390.8748, 363.9270,
         326.3857, 292.1116, 271.5204, 260.7120, 256.2755, 254.6814, 254.0658,
         254.3381, 254.8025, 255.6172, 259.0939, 259.9914, 260.5601, 261.1755,
         260.7111, 260.3467, 259.8823, 259.6179, 259.1535, 258.8163, 259.5506,
         260.3794, 261.2082, 262.1027, 262.5671, 262.9959, 254.8739, 242.2698,
         228.5905, 218.7159, 215.1054, 211.6061, 210.4279, 209.6751, 208.8463,
         208.1175, 207.3830, 205.2497, 203.2621, 201.6528, 201.1184, 202.3936,
         209.0857, 225.9320, 261.6603, 287.7431, 298.9687, 306.3492, 306.0547,
         301.6857, 299.6145, 301.0732, 305.2245, 309.7059, 316.2728, 322.8156,
         328.0333, 332.0032, 333.3061, 333.5197, 332.4719, 331.1374, 329.0798,
         328.2556, 328.4633, 329.2733, 330.0941, 331.0041, 331.4000, 331.1846,
         331.0000, 330.9596, 330.7000, 330.6884, 331.0293, 332.0431, 333.9898,
         338.6444, 349.5252, 353.6864, 354.5608, 353.7946, 352.9980, 351.9689,
         350.6095, 351.0000, 351.2628, 351.4900, 351.0184, 346.1959, 341.0426,
         340.1524, 339.6320, 339.3000, 342.1082, 351.4830, 356.6329, 358.9150,
         357.8047, 356.4930, 353.8640, 351.3961, 348.7419, 347.0490, 346.1152,
         346.3238, 346.9204, 347.6170, 348.4984, 350.0170, 350.9068, 351.4356,
         350.8000, 350.0034, 349.6932, 350.5830, 351.4864, 352.1610, 351.1408,
         349.3952, 344.2569, 336.6469, 326.9342, 313.1438, 297.7435, 283.0100,
         268.3556, 256.1184, 246.1202, 241.4891, 238.2653, 236.2410, 236.1639,
         238.2381, 239.7168, 240.5435, 241.1816, 240.6900, 240.2628, 239.9306,
         239.6048, 240.2676, 240.8320, 241.6909, 244.8685, 250.2769, 255.6696,
         260.1127, 263.6510, 266.1224, 266.3528, 264.6864, 262.2202, 260.0193,
         258.9905, 258.5692, 259.1335, 259.6980, 260.9683, 262.3936, 263.8279,
         264.3778, 264.6100, 264.7422, 262.1737, 252.7397, 234.9694, 224.3127,
         222.8000, 222.9354, 223.2000, 223.1004, 222.6680, 222.1075, 221.6073,
         221.9286, 222.1608, 222.1070, 222.1497, 220.8837, 219.4730, 217.1306,
         218.6857, 222.3095, 224.8184, 225.8540, 223.9068, 220.6156, 216.1039,
         211.1952, 206.0728, 204.8751, 206.4317, 209.5796, 215.0302, 221.0689,
         225.1810, 228.3848, 228.3084, 225.2701, 219.6274, 213.2560, 207.0592,
         202.2476, 199.5011, 199.3510, 201.7084, 206.9150, 211.7497, 216.0671,
         220.3000, 224.2286, 226.2800, 225.5392, 222.6190, 218.8862, 216.8000,
         216.8000, 217.0000, 217.0000,219.5000, 219.5644, 250.4728, 253.3558, 256.2456, 259.1930, 262.1116,
         265.1302, 268.1487, 271.2673, 274.3860, 277.5045, 280.7095, 283.9603,
         287.2111, 290.4619, 293.8127, 297.1635, 300.5939, 282.2585, 279.6601,
         277.2619, 274.8161, 272.9317, 263.0150, 252.1506, 244.9925, 254.7980,
         289.6222, 302.2515, 312.2034, 316.3000, 317.2519, 316.7741, 314.0678,
         311.5571, 315.1082, 326.3002, 339.3857, 349.7619, 353.7519, 352.6789,
         351.3381, 350.0617, 350.2000, 350.4000, 349.9377, 351.2599, 350.8633,
         350.1333, 348.9301, 345.7299, 334.4830, 298.8846, 276.2143, 285.3394,
         321.9556, 340.2918, 345.8812, 349.6964, 355.3551, 364.5878, 378.8533,
         392.0143, 393.9215, 392.9211, 393.7252, 393.7426, 393.4209, 392.8565,
         392.1921, 392.0862, 392.2000, 392.3011, 392.4000, 392.7000, 392.4585,
         391.8619, 390.9769, 390.6750, 391.5798, 392.4245, 392.8211, 393.2451,
         393.6095, 393.9370, 394.7150, 395.4959, 395.0658, 393.9712, 392.9102,
         391.0984, 388.6140, 365.7435, 336.5537, 322.7469, 328.6980, 373.6721,
         386.9222, 392.1286, 394.6397, 394.9220, 392.6408, 390.3848, 388.6463,
         394.5524, 407.2102, 420.5571, 434.9980, 442.6438, 447.3776, 447.1292,
         446.0746, 444.6374, 440.9558, 436.8705, 434.4891, 435.4735, 437.9955,
         440.7175, 442.0163, 433.7390, 411.1986, 405.6748, 418.2880, 430.5467,
         440.9857, 450.3630, 456.2462, 464.9796, 474.8955, 494.5122, 523.5266,
         532.4032, 533.1116, 530.3082, 525.5964, 522.9547, 522.1694, 522.9059,
         524.6397, 524.4191, 521.7086, 505.8925, 471.2163, 459.9184, 466.7952,
         481.4667, 498.6945, 520.4959, 529.2885, 533.2834, 535.2603, 535.5673,
         533.5365, 528.4721, 522.2755, 515.8721, 512.3247, 511.7381, 513.3635,
         516.2825, 521.4592, 527.7043, 534.6796, 538.7939, 538.5488, 534.7669,
         528.2762, 520.6979, 514.3868, 512.7000, 512.8383, 514.3168, 518.1490,
         522.1238, 525.5068, 527.6953, 528.1326, 522.8345, 514.2122, 499.2755,
         487.3746, 488.3027, 491.2213, 493.8692, 494.2673, 492.7458, 484.0707,
         464.3429, 425.6172, 371.8714, 318.9905, 287.2778, 270.2381, 263.4429,
         260.8667, 260.3268, 260.6776, 261.6308, 262.4798, 260.0184, 256.4828,
         255.8365, 256.5748, 256.8000, 257.1649, 259.3531, 261.1801, 262.6079,
         263.9714, 264.4236, 263.7948, 262.9245, 262.1279, 261.5000, 261.3449,
         261.3000, 260.7635, 259.1415, 258.2483, 258.1322, 258.7966, 260.3855,
         262.9508, 263.7347, 264.2000, 263.6721, 262.2095, 260.7315, 259.5413,
         262.6762, 270.5633, 282.2721, 304.5571, 353.5118, 384.2930, 412.1102,
         428.1651, 437.8449, 442.2558, 441.6996, 440.9308, 439.9755, 440.8268,
         439.3222, 432.0415, 428.7007, 427.5129, 429.1769, 432.2971, 438.6626,
         444.5428, 442.9816, 441.0132, 439.8673, 439.0707, 438.5247, 438.7075,
         439.0000, 439.2000, 441.5408, 444.2717, 446.9794, 443.7606, 430.2218,
         425.5651, 438.0986, 460.1050, 502.2254, 521.7735, 526.3519, 530.4410,
         531.4905, 525.8383, 503.9030, 471.2340, 475.2540, 498.2959, 508.4000,
         504.7984, 499.6021, 493.0524, 484.2261, 476.0812, 469.9395, 474.4433,
         498.2508, 514.3857, 521.3850, 523.8379, 523.0796, 521.8818, 520.1932,
         519.2333, 518.4034, 518.1243, 519.2531, 520.0864, 520.8830, 520.8802,
         522.5127, 525.4639, 527.9258, 527.8907, 525.7331, 521.1143, 515.0538,
         510.6555, 510.5966, 513.1005, 516.8655, 522.9952, 530.1968, 534.3386,
         535.1000, 531.6740, 526.0170, 516.0061, 503.3306, 494.2191, 491.5197,
         490.4905, 489.2950, 487.1061, 483.8272, 477.9855, 466.4354, 446.9007,
         419.2064, 392.8544, 376.0750, 366.4925, 361.8306, 359.5175, 357.9052,
         356.8429, 356.1463, 356.3676, 370.3170, 382.9531, 387.5603, 389.1980,
         391.0444, 392.6066, 393.2265, 394.0052, 394.8930, 395.3585, 386.8449,
         381.6921, 382.0102, 383.0712, 384.1658, 385.5891, 394.8494, 399.3370,
         397.9381, 396.6628, 395.4018, 394.2327, 394.0000, 393.8875, 393.8000,
         393.2175, 392.6585, 391.9946, 390.2311, 388.8079, 385.5204, 382.3170,
         381.8762, 384.8864, 389.5043, 391.6837, 392.1252, 393.2422, 393.8000,
         393.9714, 393.9891, 393.3925, 392.4959, 391.8993, 391.1379, 390.3708,
         390.1937, 391.0580, 391.8061, 392.2000, 392.2000, 392.7048, 394.5302,
         394.4778, 394.3000, 393.8268, 391.3989, 384.6061, 368.1263, 352.3780,
         363.3286, 372.3340, 381.0447, 388.6381, 396.4095, 404.9447, 415.2551,
         426.4698, 433.9721, 442.5844, 446.7000, 446.3891, 444.2259, 443.0014,
         442.3016, 441.1776, 439.9603, 435.8497, 415.6388, 379.8819, 393.3596,
         418.0810, 433.5964, 440.2292, 435.6633, 415.5401, 392.2812, 388.3830,
         388.6444, 389.6628, 390.5408, 391.5832, 391.1660, 390.7204, 390.9424,
         391.3238, 392.0136, 392.7560, 392.6168, 390.9966, 391.8340, 396.4984,
         405.1000, 415.4202, 425.3624, 434.1844, 440.1608, 442.8100, 443.9000,
         442.1698, 438.6785, 436.1021, 434.4560, 434.4542, 435.1456, 437.6256,
         437.2524, 438.1320, 439.1608, 439.7104, 439.3592, 439.7000, 439.8880,
         440.2524, 440.3665, 439.7812, 440.6639, 441.7249, 442.3884, 441.9306,
         441.2984, 440.7986, 440.3680, 439.9000, 440.1873, 438.8497, 438.9948,
         439.6809, 440.3184, 439.2689, 439.2472, 439.4442, 438.4721, 437.5000,
         437.5524, 437.7000, 437.8336, 438.0000, 439.4871, 438.2796, 438.7191,
         438.8667, 438.3701, 437.4626, 436.2231, 436.6197, 437.3163, 438.7097,
         441.5413, 444.5599, 447.5109, 448.5993, 448.9959, 448.8866, 446.3508,
         442.2714, 437.8199, 431.5757, 429.6986, 429.0163, 431.1853, 435.9007,
         439.8635, 446.2435, 450.2204, 451.3494, 450.5862, 448.5504, 444.4567,
         439.6540, 434.5803, 431.6937, 430.2442, 431.8306, 435.9494, 441.7513,
         445.9714, 448.5587, 450.2224, 450.7905, 448.3302, 444.3191, 438.6592,
         431.7254, 426.6152, 422.2034, 421.8338, 423.8381, 428.8231, 433.7138,
         438.7556, 443.8184, 447.7798, 448.2000, 448.7531, 451.0007, 449.5100,
         447.9143, 446.2211, 445.4000]
f0 = f0[:sum(durations)]
f0 = np.array(f0)
pos = 0
for i, d in enumerate(durations):
    if phseq[i] == 0:
        f0[pos:pos+d] = 0
    pos += d

print(f0)
if len(f0)<sum(durations):
    padf0 = np.zeros((sum(durations),))
    padf0[:len(f0)] = f0
    f0 = padf0
f0 = torch.FloatTensor(f0).unsqueeze(0)

# nonzero_ids = np.where(f0 != 0)[0]
# interp_fn = interp1d(
#     nonzero_ids,
#     f0[nonzero_ids],
#     fill_value=(f0[nonzero_ids[0]], f0[nonzero_ids[-1]]),
#     bounds_error=False,
# )
# pitch = interp_fn(np.arange(0, len(f0)))
#
# pos = 0
# for i, d in enumerate(durations):
#     if d > 0:
#         pitch[i] = np.mean(pitch[pos: pos + d])
#     else:
#         pitch[i] = 0
#     pos += d
# pitch = pitch[: len(durations)]
# pitch = torch.FloatTensor(pitch).unsqueeze(0)
# print(pitch)

# def get_avg(x):
#     if len(x[x != 0]) == 0:
#         return 0
#     else:
#         return np.average(x[x != 0])
#
# phf0 = []
# pos = 0
# for i, d in enumerate(durations):
#
#     phf0.append(get_avg(f0[pos:pos+d]))
#     pos += d
# pitch = np.array(phf0)
pitch = np.array([ 0, 65, 65, 67, 67, 69, 69, 70, 70, 67, 67, 69, 72, 72, 72,  0, 60, 60,
         67, 67, 69, 69, 69, 69,  0, 60, 60, 64, 64, 65, 65, 65, 65, 60, 60, 57,
         57,  0.0,0, 65, 65, 67, 67, 69, 69, 72, 72, 72, 72,  0, 60, 60, 60, 60, 69, 69,
         69, 69, 72, 72, 72, 72,  0, 67, 67, 67, 67, 67, 67, 69, 69, 67, 67, 69,
          0])
pitch = 440 * (2 ** ((pitch - 69) / 12))

pitch = torch.FloatTensor(pitch).unsqueeze(0)
print(pitch)
hps = utils.get_hparams_from_file("configs/ms.json")
net_g = SynthesizerTrn(
  len(symbols),
  hps.data.filter_length // 2 + 1,
  hps.data.hop_length,
  hps.data.sampling_rate,
  hps.train.segment_size // hps.data.hop_length,
  n_speakers=hps.data.n_speakers,
  **hps.model)

_ = net_g.eval()

_ = utils.load_checkpoint("/Volumes/Extend/下载/modelnsf(1).pth", net_g, None)


text_norm = torch.LongTensor(phseq)
x_tst = text_norm.unsqueeze(0)
x_tst_lengths = torch.LongTensor([text_norm.size(0)])
spk = torch.LongTensor([100])
manual_f0 = torch.FloatTensor(f0).unsqueeze(0)
manual_dur = torch.LongTensor(durations).unsqueeze(0)

result = net_g.infer(x_tst, x_tst_lengths, noise_scale=.667, noise_scale_w=0.8, sid=spk,
                     length_scale=1, phone_f0=pitch, manual_duration=manual_dur, frame_f0=None)
audio = result[0][0, 0].data.float().numpy()
soundfile.write("samples/singnof0.wav", audio, 44100)

result = net_g.infer(x_tst, x_tst_lengths, noise_scale=.667, noise_scale_w=0.8, sid=spk,
                     length_scale=1, phone_f0=pitch, manual_duration=manual_dur, frame_f0=f0)
audio = result[0][0, 0].data.float().numpy()
soundfile.write("samples/singf0.wav", audio, 44100)